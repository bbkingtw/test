<!DOCTYPE html><html><head><title>ComponentLoader.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../index.html" class="source"><span class="file_name">README</span></a><a href="../../src/components/SimplifyObject.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">SimplifyObject.coffee</span></a><a href="../../src/components/Callback.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">Callback.coffee</span></a><a href="../../src/components/SplitInSequence.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">SplitInSequence.coffee</span></a><a href="../../src/components/GroupByObjectKey.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">GroupByObjectKey.coffee</span></a><a href="../../src/components/DirName.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">DirName.coffee</span></a><a href="../../src/components/FilterPacket.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">FilterPacket.coffee</span></a><a href="../../src/components/RepeatAsync.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">RepeatAsync.coffee</span></a><a href="../../src/components/Template.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">Template.coffee</span></a><a href="../../src/components/CollectUntilIdle.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">CollectUntilIdle.coffee</span></a><a href="../../src/components/ParseJson.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">ParseJson.coffee</span></a><a href="../../src/components/UniquePacket.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">UniquePacket.coffee</span></a><a href="../../src/components/ReadFileRaw.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">ReadFileRaw.coffee</span></a><a href="../../src/components/ReadEnv.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">ReadEnv.coffee</span></a><a href="../../src/components/Output.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">Output.coffee</span></a><a href="../../src/components/SliceArray.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">SliceArray.coffee</span></a><a href="../../src/components/ReadGroup.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">ReadGroup.coffee</span></a><a href="../../src/components/GroupRouter.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">GroupRouter.coffee</span></a><a href="../../src/components/Stat.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">Stat.coffee</span></a><a href="../../src/components/Replace.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">Replace.coffee</span></a><a href="../../src/components/Graph.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">Graph.coffee</span></a><a href="../../src/components/SplitArray.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">SplitArray.coffee</span></a><a href="../../src/components/Throttle.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">Throttle.coffee</span></a><a href="../../src/components/SetPropertyValue.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">SetPropertyValue.coffee</span></a><a href="../../src/components/Drop.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">Drop.coffee</span></a><a href="../../src/components/Base64Encode.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">Base64Encode.coffee</span></a><a href="../../src/components/GetObjectKey.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">GetObjectKey.coffee</span></a><a href="../../src/components/Kick.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">Kick.coffee</span></a><a href="../../src/components/MapPropertyValue.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">MapPropertyValue.coffee</span></a><a href="../../src/components/Concat.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">Concat.coffee</span></a><a href="../../src/components/ReadDocument.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">ReadDocument.coffee</span></a><a href="../../src/components/RemoveGroups.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">RemoveGroups.coffee</span></a><a href="../../src/components/GroupByPacket.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">GroupByPacket.coffee</span></a><a href="../../src/components/MapProperty.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">MapProperty.coffee</span></a><a href="../../src/components/FirstGroup.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">FirstGroup.coffee</span></a><a href="../../src/components/SplitStr.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">SplitStr.coffee</span></a><a href="../../src/components/CompileString.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">CompileString.coffee</span></a><a href="../../src/components/CollectGroups.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">CollectGroups.coffee</span></a><a href="../../src/components/MapGroup.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">MapGroup.coffee</span></a><a href="../../src/components/ReadFile.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">ReadFile.coffee</span></a><a href="../../src/components/FilterPropertyValue.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">FilterPropertyValue.coffee</span></a><a href="../../src/components/CountSum.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">CountSum.coffee</span></a><a href="../../src/components/WriteFile.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">WriteFile.coffee</span></a><a href="../../src/components/PropertiesToObjects.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">PropertiesToObjects.coffee</span></a><a href="../../src/components/Group.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">Group.coffee</span></a><a href="../../src/components/DuplicateProperty.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">DuplicateProperty.coffee</span></a><a href="../../src/components/Merge.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">Merge.coffee</span></a><a href="../../src/components/RemoveProperty.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">RemoveProperty.coffee</span></a><a href="../../src/components/LastPacket.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">LastPacket.coffee</span></a><a href="../../src/components/MergeGroups.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">MergeGroups.coffee</span></a><a href="../../src/components/CreateObject.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">CreateObject.coffee</span></a><a href="../../src/components/SendString.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">SendString.coffee</span></a><a href="../../src/components/FlattenObject.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">FlattenObject.coffee</span></a><a href="../../src/components/ReadDir.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">ReadDir.coffee</span></a><a href="../../src/components/WriteFileRaw.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">WriteFileRaw.coffee</span></a><a href="../../src/components/FilterProperty.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">FilterProperty.coffee</span></a><a href="../../src/components/Counter.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">Counter.coffee</span></a><a href="../../src/components/Repeat.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">Repeat.coffee</span></a><a href="../../src/components/SubStr.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">SubStr.coffee</span></a><a href="../../src/components/SetProperty.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">SetProperty.coffee</span></a><a href="../../src/components/CreateDate.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">CreateDate.coffee</span></a><a href="../../src/components/CopyFile.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">CopyFile.coffee</span></a><a href="../../src/components/MakeDir.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">MakeDir.coffee</span></a><a href="../../src/components/Split.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">Split.coffee</span></a><a href="../../src/components/UniqueArray.coffee.html" class="source "><span class="base_path">src / components / </span><span class="file_name">UniqueArray.coffee</span></a><a href="../../src/lib/Network.coffee.html" class="source "><span class="base_path">src / lib / </span><span class="file_name">Network.coffee</span></a><a href="../../src/lib/AsyncComponent.coffee.html" class="source "><span class="base_path">src / lib / </span><span class="file_name">AsyncComponent.coffee</span></a><a href="../../src/lib/Graph.coffee.html" class="source "><span class="base_path">src / lib / </span><span class="file_name">Graph.coffee</span></a><a href="../../src/lib/Port.coffee.html" class="source "><span class="base_path">src / lib / </span><span class="file_name">Port.coffee</span></a><a href="../../src/lib/ComponentLoader.coffee.html" class="source selected"><span class="base_path">src / lib / </span><span class="file_name">ComponentLoader.coffee</span></a><a href="../../src/lib/shell.coffee.html" class="source "><span class="base_path">src / lib / </span><span class="file_name">shell.coffee</span></a><a href="../../src/lib/ArrayPort.coffee.html" class="source "><span class="base_path">src / lib / </span><span class="file_name">ArrayPort.coffee</span></a><a href="../../src/lib/Component.coffee.html" class="source "><span class="base_path">src / lib / </span><span class="file_name">Component.coffee</span></a><a href="../../src/lib/Fbp.coffee.html" class="source "><span class="base_path">src / lib / </span><span class="file_name">Fbp.coffee</span></a><a href="../../src/lib/NoFlo.coffee.html" class="source "><span class="base_path">src / lib / </span><span class="file_name">NoFlo.coffee</span></a><a href="../../src/lib/InternalSocket.coffee.html" class="source "><span class="base_path">src / lib / </span><span class="file_name">InternalSocket.coffee</span></a><a href="../../src/bin/noflo.coffee.html" class="source "><span class="base_path">src / bin / </span><span class="file_name">noflo.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>ComponentLoader.coffee</h1><div class="filepath">src/lib/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span class="nv">reader = </span><span class="nx">require</span> <span class="s">&#39;read-installed&#39;</span>
<span class="p">{</span><span class="nx">_</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&#39;underscore&#39;</span>
<span class="nv">path = </span><span class="nx">require</span> <span class="s">&#39;path&#39;</span>
<span class="nv">fs = </span><span class="nx">require</span> <span class="s">&#39;fs&#39;</span>
<span class="nv">internalSocket = </span><span class="nx">require</span> <span class="s">&#39;./InternalSocket&#39;</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>We allow components to be un-compiled CoffeeScript</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">require</span> <span class="s">&#39;coffee-script&#39;</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Disable NPM logging in normal NoFlo operation</p>
</td><td class="code"><div class="highlight"><pre><span class="nv">log = </span><span class="nx">require</span> <span class="s">&#39;npmlog&#39;</span>
<span class="nx">log</span><span class="p">.</span><span class="nx">pause</span><span class="p">()</span>

<span class="k">class</span> <span class="nx">ComponentLoader</span>
  <span class="nv">constructor: </span><span class="nf">(@baseDir) -&gt;</span>
    <span class="vi">@components = </span><span class="kc">null</span>
    <span class="vi">@checked = </span><span class="p">[]</span>
    <span class="vi">@revalidate = </span><span class="kc">false</span>

  <span class="nv">getModulePrefix: </span><span class="nf">(name) -&gt;</span>
    <span class="k">return</span> <span class="s">&#39;&#39;</span> <span class="nx">unless</span> <span class="nx">name</span>
    <span class="nx">name</span><span class="p">.</span><span class="nx">replace</span> <span class="s">&#39;noflo-&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span>

  <span class="nv">getModuleComponents: </span><span class="nf">(moduleDef, callback) -&gt;</span>
    <span class="nv">components = </span><span class="p">{}</span>
    <span class="nx">@checked</span><span class="p">.</span><span class="nx">push</span> <span class="nx">moduleDef</span><span class="p">.</span><span class="nx">name</span>

    <span class="nv">depCount = </span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">moduleDef</span><span class="p">.</span><span class="nx">dependencies</span><span class="p">).</span><span class="nx">length</span>
    <span class="nv">done = </span><span class="nx">_</span><span class="p">.</span><span class="nx">after</span> <span class="nx">depCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">=&gt;</span>
      <span class="nx">callback</span> <span class="nx">components</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>Handle sub-modules</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">moduleDef</span><span class="p">.</span><span class="nx">dependencies</span><span class="p">,</span> <span class="p">(</span><span class="nx">def</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="nx">done</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">@checked</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">def</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>
      <span class="nx">@getModuleComponents</span> <span class="nx">def</span><span class="p">,</span> <span class="nf">(depComponents) -&gt;</span>
        <span class="k">return</span> <span class="nx">done</span><span class="p">()</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">depComponents</span>
        <span class="nx">components</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cPath</span> <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">cPath</span> <span class="k">of</span> <span class="nx">depComponents</span>
        <span class="nx">done</span><span class="p">()</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>No need for further processing for non-NoFlo projects</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="nx">done</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">moduleDef</span><span class="p">.</span><span class="nx">noflo</span>

    <span class="nv">checkOwn = </span><span class="p">(</span><span class="nx">def</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>Handle own components</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">prefix = </span><span class="nx">@getModulePrefix</span> <span class="nx">def</span><span class="p">.</span><span class="nx">name</span>

      <span class="k">if</span> <span class="nx">def</span><span class="p">.</span><span class="nx">noflo</span><span class="p">.</span><span class="nx">components</span>
        <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">cPath</span> <span class="k">of</span> <span class="nx">def</span><span class="p">.</span><span class="nx">noflo</span><span class="p">.</span><span class="nx">components</span>
          <span class="nx">components</span><span class="p">[</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">prefix</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">def</span><span class="p">.</span><span class="nx">realPath</span><span class="p">,</span> <span class="nx">cPath</span>
      <span class="k">if</span> <span class="nx">moduleDef</span><span class="p">.</span><span class="nx">noflo</span><span class="p">.</span><span class="nx">graphs</span>
        <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">gPath</span> <span class="k">of</span> <span class="nx">def</span><span class="p">.</span><span class="nx">noflo</span><span class="p">.</span><span class="nx">graphs</span>
          <span class="nx">components</span><span class="p">[</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">prefix</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">def</span><span class="p">.</span><span class="nx">realPath</span><span class="p">,</span> <span class="nx">gPath</span>
      <span class="nx">done</span><span class="p">()</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Normally we can rely on the module data we get from read-installed, but in
case cache has been cleared, we must re-read the file</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">unless</span> <span class="nx">@revalidate</span>
      <span class="k">return</span> <span class="nx">checkOwn</span> <span class="nx">moduleDef</span>
    <span class="nx">@readPackageFile</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">moduleDef</span><span class="p">.</span><span class="nx">realPath</span><span class="si">}</span><span class="s">/package.json&quot;</span><span class="p">,</span> <span class="nf">(err, data) -&gt;</span>
      <span class="k">return</span> <span class="nx">done</span><span class="p">()</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">checkOwn</span> <span class="nx">data</span>

  <span class="nv">getCoreComponents: </span><span class="nf">(callback) -&gt;</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Read core components
TODO: These components should eventually be migrated to modules too</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">corePath = </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="s">&#39;../src/components&#39;</span>
    <span class="k">if</span> <span class="nx">path</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">__filename</span><span class="p">)</span> <span class="o">is</span> <span class="s">&#39;.coffee&#39;</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>Handle the non-compiled version of ComponentLoader for unit tests</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">corePath = </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="s">&#39;../components&#39;</span>

    <span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span> <span class="nx">corePath</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">components</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nv">coreComponents = </span><span class="p">{}</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="nx">coreComponents</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="k">for</span> <span class="nx">component</span> <span class="k">in</span> <span class="nx">components</span>
        <span class="k">continue</span> <span class="k">if</span> <span class="nx">component</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">is</span> <span class="s">&#39;.&#39;</span>
        <span class="p">[</span><span class="nx">componentName</span><span class="p">,</span> <span class="nx">componentExtension</span><span class="p">]</span> <span class="o">=</span> <span class="nx">component</span><span class="p">.</span><span class="nx">split</span> <span class="s">&#39;.&#39;</span>
        <span class="k">continue</span> <span class="nx">unless</span> <span class="nx">componentExtension</span> <span class="o">is</span> <span class="s">&#39;coffee&#39;</span>
        <span class="nx">coreComponents</span><span class="p">[</span><span class="nx">componentName</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">corePath</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">component</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">callback</span> <span class="nx">coreComponents</span>

  <span class="nv">listComponents: </span><span class="nf">(callback) -&gt;</span>
    <span class="k">return</span> <span class="nx">callback</span> <span class="nx">@components</span> <span class="nx">unless</span> <span class="nx">@components</span> <span class="o">is</span> <span class="kc">null</span>

    <span class="vi">@components = </span><span class="p">{}</span>
    <span class="nv">done = </span><span class="nx">_</span><span class="p">.</span><span class="nx">after</span> <span class="mi">2</span><span class="p">,</span> <span class="o">=&gt;</span>
      <span class="nx">callback</span> <span class="nx">@components</span>

    <span class="nx">@getCoreComponents</span> <span class="p">(</span><span class="nx">coreComponents</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">@components</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cPath</span> <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">cPath</span> <span class="k">of</span> <span class="nx">coreComponents</span>
      <span class="nx">done</span><span class="p">()</span>

    <span class="nx">reader</span> <span class="nx">@baseDir</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="nx">done</span><span class="p">()</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">@getModuleComponents</span> <span class="nx">data</span><span class="p">,</span> <span class="p">(</span><span class="nx">components</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">@components</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cPath</span> <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">cPath</span> <span class="k">of</span> <span class="nx">components</span>
        <span class="nx">done</span><span class="p">()</span>

  <span class="nv">isGraph: </span><span class="nf">(cPath) -&gt;</span>
    <span class="nx">cPath</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s">&#39;.fbp&#39;</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span> <span class="o">or</span> <span class="nx">cPath</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s">&#39;.json&#39;</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>

  <span class="nv">load: </span><span class="nf">(name, callback) -&gt;</span>
    <span class="nx">unless</span> <span class="nx">@components</span>
      <span class="nx">@listComponents</span> <span class="p">(</span><span class="nx">components</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">@load</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">callback</span>
      <span class="k">return</span>
    
    <span class="nx">unless</span> <span class="nx">@components</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Component </span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s"> not available&quot;</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="nx">@isGraph</span> <span class="nx">@components</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span> <span class="o">=&gt;</span>
        <span class="nx">@loadGraph</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">callback</span>
      <span class="k">return</span>

    <span class="nv">implementation = </span><span class="nx">require</span> <span class="nx">@components</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
    <span class="nx">callback</span> <span class="nx">implementation</span><span class="p">.</span><span class="nx">getComponent</span><span class="p">()</span>

  <span class="nv">loadGraph: </span><span class="nf">(name, callback) -&gt;</span>
    <span class="nv">graphImplementation = </span><span class="nx">require</span> <span class="nx">@components</span><span class="p">[</span><span class="s">&#39;Graph&#39;</span><span class="p">]</span>
    <span class="nv">graphSocket = </span><span class="nx">internalSocket</span><span class="p">.</span><span class="nx">createSocket</span><span class="p">()</span>
    <span class="nv">graph = </span><span class="nx">graphImplementation</span><span class="p">.</span><span class="nx">getComponent</span><span class="p">()</span>
    <span class="nv">graph.baseDir = </span><span class="nx">@baseDir</span>
    <span class="nx">graph</span><span class="p">.</span><span class="nx">inPorts</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">attach</span> <span class="nx">graphSocket</span>
    <span class="nx">graphSocket</span><span class="p">.</span><span class="nx">send</span> <span class="nx">@components</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
    <span class="nx">graphSocket</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">()</span>
    <span class="k">delete</span> <span class="nx">graph</span><span class="p">.</span><span class="nx">inPorts</span><span class="p">.</span><span class="nx">graph</span>
    <span class="nx">callback</span> <span class="nx">graph</span>

  <span class="nv">getPackagePath: </span><span class="nf">(packageId, callback) -&gt;</span>
    <span class="nv">found = </span><span class="kc">null</span>
    <span class="nv">find = </span><span class="nf">(packageData) -&gt;</span>
      <span class="k">if</span> <span class="nx">packageData</span><span class="p">.</span><span class="nx">name</span> <span class="o">is</span> <span class="nx">packageId</span>
        <span class="nv">found = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">packageData</span><span class="p">.</span><span class="nx">realPath</span><span class="si">}</span><span class="s">/package.json&quot;</span>
        <span class="k">return</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">packageData</span><span class="p">.</span><span class="nx">dependencies</span><span class="p">,</span> <span class="nx">find</span>
    <span class="nx">reader</span> <span class="nx">@baseDir</span><span class="p">,</span> <span class="nf">(err, data) -&gt;</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">find</span> <span class="nx">data</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">found</span>

  <span class="nv">readPackage: </span><span class="nf">(packageId, callback) -&gt;</span>
    <span class="nx">@getPackagePath</span> <span class="nx">packageId</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">packageFile</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;no package found&#39;</span> <span class="nx">unless</span> <span class="nx">packageFile</span>
      <span class="nx">@readPackageFile</span> <span class="nx">packageFile</span><span class="p">,</span> <span class="nx">callback</span>

  <span class="nv">readPackageFile: </span><span class="nf">(packageFile, callback) -&gt;</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">packageFile</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="nf">(err, packageData) -&gt;</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="nv">data = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">packageData</span>
      <span class="nv">data.realPath = </span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span> <span class="nx">packageFile</span>
      <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">data</span>

  <span class="nv">writePackage: </span><span class="nf">(packageId, data, callback) -&gt;</span>
    <span class="nx">@getPackagePath</span> <span class="nx">packageId</span><span class="p">,</span> <span class="nf">(err, packageFile) -&gt;</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;no package found&#39;</span> <span class="nx">unless</span> <span class="nx">packageFile</span>
      <span class="k">delete</span> <span class="nx">data</span><span class="p">.</span><span class="nx">realPath</span> <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">realPath</span>
      <span class="nv">packageData = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">data</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span> <span class="nx">packageFile</span><span class="p">,</span> <span class="nx">packageData</span><span class="p">,</span> <span class="nx">callback</span>

  <span class="nv">registerComponent: </span><span class="nf">(packageId, name, cPath, callback) -&gt;</span>
    <span class="nx">@readPackage</span> <span class="nx">packageId</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">packageData</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="nv">packageData.noflo = </span><span class="p">{}</span> <span class="nx">unless</span> <span class="nx">packageData</span><span class="p">.</span><span class="nx">noflo</span>
      <span class="nv">packageData.noflo.components = </span><span class="p">{}</span> <span class="nx">unless</span> <span class="nx">packageData</span><span class="p">.</span><span class="nx">noflo</span><span class="p">.</span><span class="nx">components</span>
      <span class="nx">packageData</span><span class="p">.</span><span class="nx">noflo</span><span class="p">.</span><span class="nx">components</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cPath</span>
      <span class="nx">@clear</span><span class="p">()</span>
      <span class="nx">@writePackage</span> <span class="nx">packageId</span><span class="p">,</span> <span class="nx">packageData</span><span class="p">,</span> <span class="nx">callback</span>

  <span class="nv">registerGraph: </span><span class="nf">(packageId, name, cPath, callback) -&gt;</span>
    <span class="nx">@readPackage</span> <span class="nx">packageId</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">packageData</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="nv">packageData.noflo = </span><span class="p">{}</span> <span class="nx">unless</span> <span class="nx">packageData</span><span class="p">.</span><span class="nx">noflo</span>
      <span class="nv">packageData.noflo.graphs = </span><span class="p">{}</span> <span class="nx">unless</span> <span class="nx">packageData</span><span class="p">.</span><span class="nx">noflo</span><span class="p">.</span><span class="nx">graphs</span>
      <span class="nx">packageData</span><span class="p">.</span><span class="nx">noflo</span><span class="p">.</span><span class="nx">graphs</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cPath</span>
      <span class="nx">@clear</span><span class="p">()</span>
      <span class="nx">@writePackage</span> <span class="nx">packageId</span><span class="p">,</span> <span class="nx">packageData</span><span class="p">,</span> <span class="nx">callback</span>

  <span class="nv">clear: </span><span class="o">-&gt;</span>
    <span class="vi">@components = </span><span class="kc">null</span>
    <span class="vi">@checked = </span><span class="p">[]</span>
    <span class="vi">@revalidate = </span><span class="kc">true</span>

<span class="nv">exports.ComponentLoader = </span><span class="nx">ComponentLoader</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Wed Apr 03 2013 16:29:50 GMT+0200 (CEST)  </div><div id="projectname"><a href="../../index.html">NoFlo</a></div></div></body></html>